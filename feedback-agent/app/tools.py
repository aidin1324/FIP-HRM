import requests
import os
from langchain_core.tools import tool
from dotenv import load_dotenv
import logging

load_dotenv()

BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")

logger = logging.getLogger(__name__)

@tool(return_direct=True)
def send_feedback_to_manager(conversation_summary: str, comments: str) -> str:
    """
    <What it does>
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á–µ—Ç –ø–æ –æ—Ç–∑—ã–≤—É —Ä–µ–∞–ª—å–Ω–æ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É –≤ Telegram.
    <What it does>

    <When it needs>
    –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–≤–∏–ª —Å–≤–æ–µ –º–Ω–µ–Ω–∏–µ –∏–ª–∏ —Ä–∞—Å—Å–∫–∞–∑–∞–ª –æ –ø—Ä–æ–±–ª–µ–º–µ, –æ—Ü–µ–Ω–∏–ª –∫–∞—á–µ—Å—Ç–≤–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞ –∏–ª–∏ –æ—Å—Ç–∞–ª—å–Ω–æ–µ –∫–∞—Å–∞—Ç–µ–ª—å–Ω–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞, –∏ –¥–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ –±–µ—Å–µ–¥—ã.
    <When it needs>

    Args:
        conversation_summary: –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ (—Ä–µ–∑—é–º–µ) –¥–∏–∞–ª–æ–≥–∞. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ø–µ—Ä–µ—Å–∫–∞–∑–æ–º –¥–∏–∞–ª–æ–≥–∞ —Å –≥–æ—Å—Ç–µ–º, –Ω–µ —É–ø—É—Å–∫–∞—è –≤–∞–∂–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π.
        comments: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–ª–∏ –æ—Ç–∑—ã–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/—Å–∏—Å—Ç–µ–º—ã. –ö—Ä–∞—Ç–∫–æ, –∫–∞–∫–∏–µ –≤–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –±—ã–ª–æ –∑–∞–º–µ—á–µ–Ω–æ, —á—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å, —É–ø–æ–º—è–Ω—É—Ç—ã–µ –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ (–∏–º–µ–Ω–∞, —Ñ–∞–∫—Ç—ã). –≠—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–∂–Ω–æ –æ–ø–æ–≤–µ—Å—Ç–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞.

    <Reccomendation>
    conversation_summary: –ø–µ—Ä–µ—Å–∫–∞–∑ –¥–∏–∞–ª–æ–≥ —Å –≥–æ—Å—Ç–µ–º, –∫–∞–∫ –º–æ–∂–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–µ–π, –Ω–µ —É–ø—É—Å–∫–∞—è –≤–∞–∂–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π
    comments: –∫—Ä–∞—Ç–∫–æ, –∫–∞–∫–∏–µ –≤–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –±—ã–ª–æ –∑–∞–º–µ—á–µ–Ω–æ, —á—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å, —É–ø–æ–º—è–Ω—É—Ç—ã–µ –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –≤ —Ö–æ–¥–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞, –∫–∞–∫ –∏–º–µ–Ω–∞ –∏–ª–∏ –¥—Ä—É–≥–∏–µ —ç–ø–∏–∑–æ–¥–∏—á–µ—Å–∫–∏–µ –∏–ª–∏ —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è. –≠—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –∫–æ—Ç–æ—Ä—ã–µ –ø–æ —Ç–≤–æ–µ–º—É –≤–∞–∂–Ω–æ –æ–ø–æ–≤–µ—Å—Ç–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    <Reccomendation>
    """
    if not BOT_TOKEN or not CHAT_ID:
        error_msg = "–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è TELEGRAM_BOT_TOKEN –∏–ª–∏ TELEGRAM_CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."
        logger.error(error_msg)
        return f"–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {error_msg}"

    message = f"üìù *–ù–æ–≤—ã–π –æ—Ç–∑—ã–≤ –æ—Ç –≥–æ—Å—Ç—è*\n\n"
    message += f"*–†–µ–∑—é–º–µ –¥–∏–∞–ª–æ–≥–∞:*\n{conversation_summary}\n\n"
    message += f"*–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã/–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:*\n{comments}"

    url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
    payload = {
        'chat_id': CHAT_ID,
        'text': message,
        'parse_mode': 'Markdown'
    }

    try:
        response = requests.post(url, json=payload, timeout=10)
        response.raise_for_status()
        logger.info(f"–û—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram —á–∞—Ç {CHAT_ID}")
        return "–ú—ã —É–≤–µ–¥–æ–º–∏–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞, –±–ª–∞–≥–æ–¥–∞—Ä–∏–º –≤–∞—Å!"
    except requests.exceptions.RequestException as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram: {e}")
        return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–∑—ã–≤–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—É: {e}"
    except Exception as e:
        logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Telegram: {e}")
        return f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–∑—ã–≤–∞: {e}"
